(function(){"use strict";function t(t,n){var r="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!r){if(Array.isArray(t)||(r=function(t,n){if(t){if("string"==typeof t)return e(t,n);var r=Object.prototype.toString.call(t).slice(8,-1);return"Object"===r&&t.constructor&&(r=t.constructor.name),"Map"===r||"Set"===r?Array.from(t):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?e(t,n):void 0}}(t))||n&&t&&"number"==typeof t.length){r&&(t=r);var o=0,a=function(){};return{s:a,n:function(){return o>=t.length?{done:!0}:{done:!1,value:t[o++]}},e:function(t){throw t},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var i,l=!0,s=!1;return{s:function(){r=r.call(t)},n:function(){var t=r.next();return l=t.done,t},e:function(t){s=!0,i=t},f:function(){try{l||null==r.return||r.return()}finally{if(s)throw i}}}}function e(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,r=new Array(e);n<e;n++)r[n]=t[n];return r}function n(t){return n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},n(t)}function r(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function o(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}function a(t,e,n){return e&&o(t.prototype,e),n&&o(t,n),Object.defineProperty(t,"prototype",{writable:!1}),t}var i=function(){function t(e,n){r(this,t),this.ele=e&&e.toLowerCase(),this.props=n,this.children=[]}return a(t,[{key:"pushChildren",value:function(t){this.children.push(t)}}]),t}();const l=function(){function e(){r(this,e)}return a(e,[{key:"isStyle",value:function(t,e){return"style"===t&&"object"===n(e)}},{key:"isAttr",value:function(t,e){return"attr"===t&&"object"===n(e)}},{key:"isPseudo",value:function(t,e){return"pseudo"===t&&"object"===n(e)}},{key:"isEventListener",value:function(t,e){return t.startsWith("on")&&"function"==typeof e}},{key:"isElementVdom",value:function(t){return"object"===n(t)&&"string"==typeof t.ele}},{key:"isTextVdom",value:function(t){return"string"==typeof t||"number"==typeof t}},{key:"render",value:function(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,r=n?function(t){return n.appendChild(t)}:function(t){return t};if(this.isTextVdom(e))return r(document.createTextNode(e));if(this.isElementVdom(e)){var o=document.createElement(e.ele);for(var a in"input"===e.ele&&(o.readOnly="readOnly"),e.props.attr["data-id"]=n.dataset.id?n.dataset.id+"-"+(n.children.length+1):n.children.length+1,o.dataset.id=e.props.attr["data-id"],e.props)this.setAttribute(o,a,e.props[a]);var i,l=t(e.children);try{for(l.s();!(i=l.n()).done;){var s=i.value;this.render(s,o)}}catch(t){l.e(t)}finally{l.f()}return r(o)}}},{key:"setAttribute",value:function(t,e,n){if(this.isEventListener(e,n)){var r=e.slice(2).toLowerCase();t.addEventListener(r,n)}else if(this.isStyle(e,n))Object.assign(t.style,n);else if(this.isAttr(e,n))for(var o in n)"class"===o?t.className=n[o]:t[o]=n[o];else if(this.isPseudo(e,n)&&Object.entries(n).length>0){var a="",i=document.createElement("style");for(var l in t.className.indexOf("_test")>=0?t.className=t.className.replace("_test","a"+t.dataset.id):t.className+="a"+t.dataset.id,n){for(var s in a+="".concat(l.indexOf("_test")>=0?l.replace("_test",t.className):l,"{"),n[l])a+="".concat(s,":").concat(n[l][s],";");a+="}"}i.innerHTML=a,t.appendChild(i)}}},{key:"toVDom",value:function(t){var e=this,n=t.nodeType,r=null;return 1===n?function(){for(var n=t.nodeName,o=t.attributes,a={attr:{},style:{}},l=t.childNodes,s=0;s<o.length;s++)"style"===o[s].nodeName?o[s].nodeValue.split(";").forEach((function(t){if(""!==t){var e=t.split(":");a.style[e[0]]=e[1]}})):a.attr[o[s].nodeName]=o[s].nodeValue;r=new i(n,a);for(var c=0;c<l.length;c++)null!==l[c].nodeValue?""!==l[c].nodeValue.replace(/^\n {0,}$/g,"")&&r.pushChildren(e.toVDom(l[c])):r.pushChildren(e.toVDom(l[c]))}():3===n&&(r=t.nodeValue.replace(/^\n {0,}$/g,"")),r}},{key:"pseudoToObject",value:function(e){var n,r={},o=t(e);try{for(o.s();!(n=o.n()).done;){var a=n.value;r[a.selectorText]={};var i,l=t(a.style);try{for(l.s();!(i=l.n()).done;){var s=i.value;"initial"!==a.style[s]&&(r[a.selectorText][s]=a.style[s])}}catch(t){l.e(t)}finally{l.f()}}}catch(t){o.e(t)}finally{o.f()}return r}}]),e}();function s(t){return s="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},s(t)}function c(t){return function(t){if(Array.isArray(t))return f(t)}(t)||function(t){if("undefined"!=typeof Symbol&&null!=t[Symbol.iterator]||null!=t["@@iterator"])return Array.from(t)}(t)||d(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function u(t,e){var n="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!n){if(Array.isArray(t)||(n=d(t))||e&&t&&"number"==typeof t.length){n&&(t=n);var r=0,o=function(){};return{s:o,n:function(){return r>=t.length?{done:!0}:{done:!1,value:t[r++]}},e:function(t){throw t},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,i=!0,l=!1;return{s:function(){n=n.call(t)},n:function(){var t=n.next();return i=t.done,t},e:function(t){l=!0,a=t},f:function(){try{i||null==n.return||n.return()}finally{if(l)throw a}}}}function d(t,e){if(t){if("string"==typeof t)return f(t,e);var n=Object.prototype.toString.call(t).slice(8,-1);return"Object"===n&&t.constructor&&(n=t.constructor.name),"Map"===n||"Set"===n?Array.from(t):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?f(t,e):void 0}}function f(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,r=new Array(e);n<e;n++)r[n]=t[n];return r}function p(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function y(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}function h(t,e,n){return e&&y(t.prototype,e),n&&y(t,n),Object.defineProperty(t,"prototype",{writable:!1}),t}var m=function(){function t(){p(this,t),this.container=null,this.layerWrap=document.querySelector("#layer"),this.com=new v,this.editArea=new g,this.pageCOMs=[],this.currentFollow=null,this.init()}return h(t,[{key:"init",value:function(){var t=this,e=document.querySelector("iframe");e.srcdoc='<html><head><style>.follow {outline: 2px dashed red !important;}</style></head><body><div id="container" style="min-height:100vh"></div></body></html>',e.onload=function(){t.container=e.contentDocument.querySelector("#container"),t.addEvent(2)},this.com.load().then((function(){return t.addEvent(1)}))}},{key:"addEvent",value:function(t){var e=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.com.ele;1===t?function(){var t,e=n.length>0?SystemMenu(n):[],r=u(n);try{for(r.s();!(t=r.n()).done;){var o=t.value;o.ondragstart=function(t){t.stopPropagation(),t.dataTransfer.setData("text/plain",this.dataset.id),this.style.opacity=.5},o.ondragend=function(){this.style.opacity=1},o.addEventListener("contextmenu",(function(){e.forEach((function(t){switch(t.type){case"edit":case"delete":t.ele.onclick=function(){}}}))}))}}catch(t){r.e(t)}finally{r.f()}}():2===t&&(this.container.ondrop=function(t){if(t.preventDefault(),t.stopPropagation(),"true"===t.target.dataset.drop||t.target===e.container){var n=t.dataTransfer.getData("text/plain"),r=e.com.data.filter((function(t){return t.ID===n}));if(t.target.style.background="",r.length>0){if((r=JSON.parse(JSON.stringify(r[0]))).ID=t.target.dataset.id?t.target.dataset.id+"-"+(t.target.children.length+1):t.target.children.length+1+"",r.ele=e.com.vdom.render(r.HtmlJson,t.target),"input"===r.HtmlJson.ele){var o=document.createElement("div"),a=r.ele.parentNode;o.style.display="inline",o.dataset.id=r.ele.dataset.id,o.append(r.ele),a.appendChild(o)}var i=document.createElement("li");i.dataset.id=r.ID,i.innerText=r.Name,i.onclick=function(t){var n=e.searchEleJson(t.target.dataset.id);e.editArea.load(n),e.focus(n.ele)},e.layerWrap.appendChild(i),r.ele.onclick=function(t){t.preventDefault(),t.stopPropagation();var n=e.searchEleJson(t.target.dataset.id);return e.editArea.load(n),e.focus(t.target),!1},e.pushChildren(r)}}},this.container.ondragenter=function(t){t.preventDefault(),t.stopPropagation(),"true"!==t.target.dataset.drop&&t.target!==e.container||(t.target.style.background="#eee"),null!==e.currentFollow&&(e.currentFollow.classList.toggle("follow"),e.currentFollow=null,e.editArea.clear())},this.container.ondragleave=function(t){t.preventDefault(),t.stopPropagation(),"true"!==t.target.dataset.drop&&t.target!==e.container||(t.target.style.background="")},this.container.ondragover=function(t){t.preventDefault(),t.stopPropagation()})}},{key:"pushChildren",value:function(t){var e=null,n=t.ID.split("-");if(n.length>1){for(e=this.pageCOMs[n[0]-1],n.shift();n.length>1;)e=e.HtmlJson.children[n[0]-1],n.shift();e.HtmlJson.children.push(t)}else this.pageCOMs.push(t);console.log(this.pageCOMs)}},{key:"searchEleJson",value:function(t){for(var e,n,r=c(this.pageCOMs);e=r.shift();){if(void 0!==n)return n;"object"===s(e)&&void 0===n&&(n=function(e){if(e.ID===t)return e;e.HtmlJson&&e.HtmlJson.children&&r.push.apply(r,c(e.HtmlJson.children))}(e))}return n}},{key:"focus",value:function(t){"input"===t.nodeName.toLowerCase()&&(t=t.parentNode),null!==this.currentFollow&&this.currentFollow.classList.toggle("follow"),this.currentFollow=t,t.className.indexOf("follow")<0&&(t.className+=" follow")}}]),t}(),v=function(){function t(){p(this,t),this.ele=document.getElementsByClassName("com"),this.data=null,this.vdom=new l}return h(t,[{key:"load",value:function(){var t=this;return new Promise((function(e){var n=document.querySelector("head"),r=document.createElement("style");b.conn({type:"get",url:"./test.json",fn:function(o){t.data=JSON.parse(o);var a="";t.data.length>0&&t.data.forEach((function(e){a+='<li class="com" draggable="true" data-id="'.concat(e.ID,'"><span>').concat(e.Name,"</span></li>"),e.HtmlJson=t.vdom.toVDom(document.createRange().createContextualFragment(e.Html).firstChild),e.Css&&(r.innerText=e.Css,n.appendChild(r),e.HtmlJson.props.pseudo=t.vdom.pseudoToObject(document.styleSheets[document.styleSheets.length-1].cssRules),r.remove())})),document.querySelector("#comWrap").innerHTML=a,e()}})}))}},{key:"update",value:function(){var t=this;return new Promise((function(e){var n=document.querySelector("head"),r=document.createElement("style");b.conn({type:"get",url:"./test.json",fn:function(o){var a=JSON.parse(o),i="";a.length>0&&(a=a.filter((function(e){return-1===t.data.indexOf(e.ID)}))).forEach((function(e){i+='<li class="com" draggable="true" data-id="'.concat(e.ID,'">').concat(e.Name,"</li>"),e.HtmlJson=t.vdom.toVDom(document.createRange().createContextualFragment(e.Html).firstChild),e.Css&&(r.innerText=e.Css,n.appendChild(r),e.HtmlJson.props.pseudo=t.vdom.pseudoToObject(document.styleSheets[document.styleSheets.length-1].cssRules),r.remove()),t.data.push(e)})),document.querySelector("#comWrap").innerHTML+=i,e(a)}})}))}},{key:"delete",value:function(t){var e=this;b.conn({type:"post",url:"/WebEdit/Delete",data:{id:t.dataset.id},fn:function(n){JSON.parse(n).status>0?(e.data.forEach((function(n,r){if(n.ID===t.dataset.id)return e.data.splice(r,0),void t.remove()})),AlertWindow({info:"刪除成功",status:"ok"})):AlertWindow({info:"刪除失敗",status:"err"})}})}}]),t}(),g=function(){function t(){p(this,t),this.editWrap=document.querySelector("#editWrap"),this.inputs=this.editWrap.getElementsByTagName("input"),this.selects=this.editWrap.getElementsByTagName("select"),this.rule=null,this.init()}return h(t,[{key:"init",value:function(){var t=this;b.conn({type:"get",url:"./editRule.json",fn:function(e){t.rule=JSON.parse(e).rule}})}},{key:"load",value:function(t){var e=this.rule.filter((function(e){return e.type===t.RuleType}))[0];if(void 0!==e){"attr"in t.HtmlJson.props||(t.HtmlJson.props.attr={}),"style"in t.HtmlJson.props||(t.HtmlJson.props.style={});var n="",r="";e.attr.forEach((function(e){var r=Object.keys(t.HtmlJson.props.attr).find((function(t){return t===Object.keys(e)[1]})),o=r?t.HtmlJson.props.attr[r]:"";n+="<div><label>".concat(e.name,"：</label>"),Array.isArray(e[Object.keys(e)[1]])?(n+='<select name="'.concat(Object.keys(e)[1],'">'),e[Object.keys(e)[1]].forEach((function(t){n+='<option value="'.concat(t,'" ').concat(t===o?"selected":"",">").concat(t,"</option>")})),n+="</select></div>"):n+='<input type="text" name="'.concat(Object.keys(e)[1],'" value="').concat(o,'" data-type="attr"/></div>')})),e.style.forEach((function(e){var r=Object.keys(t.HtmlJson.props.style).find((function(t){return t===Object.keys(e)[1]})),o=r?t.HtmlJson.props.style[r]:"";n+="<div><label>".concat(e.name,'：</label><input type="text" name="').concat(Object.keys(e)[1],'" value="').concat(o,'" data-type="style"/></div>')})),void 0!==e.isDrop&&(r+='<div><label>是否可以嵌套：</label><input type="checkbox" '.concat("true"===t.ele.dataset.drop?"checked":"",' data-type="drop"/>')),this.editWrap.innerHTML=n+""+r;for(var o=0;o<this.inputs.length;o++)this.inputs[o].onchange=function(e){if("attr"===e.target.dataset.type)""!==e.target.value?(t.ele[e.target.name]=e.target.value,t.HtmlJson.props.attr[e.target.name]=e.target.value):(t.ele.removeAttribute(e.target.name),delete t.HtmlJson.props.attr[e.target.name]);else if("style"===e.target.dataset.type){var n=e.target.name.split("-");n=n.length>1?n[0]+n[1].slice(0,1).toUpperCase()+n[1].slice(1):n[0],t.ele.style[n]=e.target.value,t.HtmlJson.props.style[e.target.name]=e.target.value}else"drop"===e.target.dataset.type&&(t.ele.dataset.drop=e.target.checked)};for(var a=0;a<this.selects.length;a++)this.selects[a].onchange=function(e){t.ele[e.target.name]=e.target.value,t.HtmlJson.props.attr[e.target.name]=e.target.value}}else this.editWrap.innerHTML=""}},{key:"clear",value:function(){this.editWrap.innerHTML=""}}]),t}(),b=function(){function t(){p(this,t)}return h(t,null,[{key:"conn",value:function(t){var e=t.type,n=t.url,r=t.data,o=t.fn;"function"!=typeof o&&(o=function(){}),"object"!==s(r)&&(r={});var a=null;window.XMLHttpRequest?a=new XMLHttpRequest:window.ActiveXObject&&(a=new ActiveXObject("Microsoft.XMLHTTP")),a.open(e,n),a.setRequestHeader("Content-Type","get"===e?"application/x-www-form-urlencoded; charset=utf-8;":"application/json"),a.onload=function(){o(a.response)},a.send("get"===e?null:JSON.stringify(r))}}]),t}();new m})();